# E2Eテスト用テスト環境セットアップ

このドキュメントは、ヒデズキック タイムテーブル予約システムの包括的なテスト環境セットアップについて説明します。モックサービス、テストデータフィクスチャ、ユーティリティを含みます。

## 概要

テスト環境は以下を目的として設計されています：
- **テスト時に実際のメール送信を避ける** - モックサービスを使用
- **様々なシナリオに対応する包括的なテストデータを提供**
- **複数のテスト環境をサポート** (unit, integration, e2e, ci)
- **信頼性が高く高速なテスト実行を可能にする**
- **テスト全体を通じて日本語ロケールサポートを維持**

## アーキテクチャ

```
tests/
├── config/
│   ├── environments.ts          # 環境固有の設定
│   └── test-environment.ts      # テスト環境管理
├── fixtures/
│   ├── remix-fixtures.ts        # Remix用Playwrightフィクスチャ
│   └── test-data.ts             # 包括的なテストデータシナリオ
├── mocks/
│   ├── email.mock.ts            # モックメールサービス（AWS SES代替）
│   └── mock-server.ts           # APIエンドポイントモック
├── utils/
│   └── test-utils.ts            # 拡張テストユーティリティ
├── e2e/
│   └── reservation-with-mocks.spec.ts  # モック使用のE2Eテスト例
├── global-setup.ts              # グローバルテストセットアップ
└── global-teardown.ts           # グローバルテストクリーンアップ
```

## モックサービス

### メールサービスモック (`tests/mocks/email.mock.ts`)

AWS SESの呼び出しをインメモリモック実装で置き換え：

- **ストレージ**: 検証用のインメモリメールストレージ
- **設定**: 設定可能な失敗率、遅延、動作
- **統計**: テスト用の送信済み/失敗メール追跡
- **テンプレート**: 本番環境と同じメールテンプレートを使用

#### 主要機能:
```typescript
// モック動作の設定
configureMockEmail({
  shouldFail: false,
  failureRate: 0.3,      // 30%失敗率
  delay: 1000,           // 1秒遅延
  maxEmails: 100         // 最大保存メール数
});

// 検証用モックメールの取得
const emails = getMockEmails();
const stats = getMockEmailStats();
```

### モックサーバー (`tests/mocks/mock-server.ts`)

E2Eテスト中のAPI呼び出しを傍受：

- **予約エンドポイントモック**: フォーム送信の処理
- **メールステータスエンドポイント**: メール検証テスト用
- **設定可能な動作**: 成功/失敗/遅延シミュレーション
- **リクエストログ**: 詳細なリクエスト/レスポンスログ

#### ファクトリーメソッド:
```typescript
// 異なるモックサーバー設定
MockServerFactory.createSuccessfulMockServer(page);
MockServerFactory.createFailingMockServer(page, 0.5);
MockServerFactory.createSlowMockServer(page, 2000);
MockServerFactory.createPartialFailureMockServer(page, 0.3);
```

## テストデータフィクスチャ

### 包括的なテストシナリオ (`tests/fixtures/test-data.ts`)

様々なシナリオに対応するリアルなテストデータを提供：

#### テスト申込者:
- **有効**: 適切な形式の標準的な日本人名
- **無効**: エッジケース（空フィールド、無効な形式）
- **エッジケース**: 長い名前、特殊文字、セキュリティテスト

#### テストレッスン:
- **実際のスケジュールデータ**: 実際のジムタイムテーブルに基づく
- **異なるレッスンタイプ**: キックボクシング、柔術、キッズ、ガールズなど
- **時間ベースシナリオ**: 過去/未来のレッスン、異なるインストラクター

#### テストシナリオ:
```typescript
const scenarios = {
  happyPath: {
    completeReservation,     // 第一希望と第二希望の両方
    firstChoiceOnly,         // 第一希望のみ
    familyClass,            // ファミリー向けクラス
    advancedClass           // 上級者向けクラス
  },
  validation: {
    invalidEmail,           // 無効なメール形式
    invalidPhone,           // 無効な電話番号形式
    emptyName,             // 必須フィールドの欠落
    pastLesson             // 過去のレッスンの予約試行
  },
  edgeCases: {
    sameLesson,            // 第一希望と第二希望が同じレッスン
    earlyLesson,           // 非常に早い時間帯
    lateLesson,            // 非常に遅い時間帯
    longName               // 非常に長い申込者名
  }
};
```

## 環境設定

### マルチ環境サポート (`tests/config/test-environment.ts`)

異なるテストレベルをサポート：

#### 環境タイプ:
- **unit**: 完全モック、高速実行
- **integration**: 部分モック、実際のビジネスロジック
- **e2e**: UI操作を含むリアルシミュレーション
- **ci**: 継続的インテグレーション用に最適化

#### 環境変数:
```typescript
// テスト固有の環境変数
const testEnvironmentVariables = {
  NODE_ENV: "test",
  MOCK_EMAIL_SENDING: "true",
  MOCK_AWS_SES: "true",
  AWS_REGION: "ap-northeast-1",
  DEBUG_MOCK_SERVICES: "true",
  // ... その他の設定
};
```

## 拡張テストユーティリティ

### TestUtilsクラス (`tests/utils/test-utils.ts`)

E2Eテスト用の包括的なユーティリティ：

#### 主要メソッド:
```typescript
// フォーム操作
await testUtils.fillReservationForm("completeReservation");
await testUtils.submitReservationForm();

// 結果検証
const successMessage = await testUtils.expectSuccessMessage();
const errors = await testUtils.getValidationErrors();

// タイムテーブル操作
await testUtils.waitForTimetableLoad();
const lessons = await testUtils.getAvailableLessons();
await testUtils.navigateToNextWeek();

// 日本語ロケールサポート
await testUtils.waitForJapaneseContent();
const hasJapaneseErrors = await testUtils.checkJapaneseValidationMessages();
```

### 追加のユーティリティクラス:

#### MockServiceUtils:
```typescript
// モックサービス管理
MockServiceUtils.setupMockServices();
MockServiceUtils.simulateEmailFailure(0.5);
MockServiceUtils.clearMockEmails();
```

#### TestEnvironmentUtils:
```typescript
// 環境管理
await TestEnvironmentUtils.setupTestEnvironment("e2e");
await TestEnvironmentUtils.teardownTestEnvironment();
```

#### FormTestUtils:
```typescript
// フォームデータ生成
const formData = FormTestUtils.createTestFormData("completeReservation");
const randomData = FormTestUtils.generateRandomTestData();
```

#### DateTimeTestUtils:
```typescript
// レッスンテスト用日付/時刻ユーティリティ
const futureDate = DateTimeTestUtils.getFutureDate(7);
const nextMonday = DateTimeTestUtils.getNextMonday();
```

## 使用例

### モックを使用した基本的なE2Eテスト:

```typescript
test("予約が正常に送信されることを確認", async ({ page }) => {
  const testUtils = new TestUtils(page);
  const mockServer = MockServerFactory.createSuccessfulMockServer(page);
  
  await mockServer.start();
  await MockServiceUtils.setupMockServices();
  
  // テスト実行
  await testUtils.goToHome();
  await testUtils.fillReservationForm("completeReservation");
  await testUtils.submitReservationForm();
  
  // 検証
  await testUtils.expectSuccessMessage();
  const emails = MockServiceUtils.getMockEmails();
  expect(emails).toHaveLength(2);
  
  await mockServer.stop();
});
```

### エラーシナリオのテスト:

```typescript
test("メールサービス失敗を処理することを確認", async ({ page }) => {
  const mockServer = MockServerFactory.createFailingMockServer(page);
  
  await mockServer.start();
  // ... テスト実行
  await testUtils.expectErrorMessage();
  
  const stats = MockServiceUtils.getMockEmailStats();
  expect(stats.failed).toBeGreaterThan(0);
});
```

### 異なるデータでのテスト:

```typescript
test("電話番号の形式を検証することを確認", async () => {
  await testUtils.fillReservationForm("invalidPhone");
  await testUtils.submitReservationForm();
  
  const errors = await testUtils.getValidationErrors();
  expect(errors.some(e => e.includes("電話番号"))).toBeTruthy();
});
```

## 設定ファイル

### Playwright設定の更新:

テスト環境は既存のPlaywright設定と統合：
- **グローバルセットアップ/ティアダウン**: モックサービスの自動初期化
- **日本語ロケールサポート**: 既存の日本語ロケール設定を維持
- **環境検出**: テスト/本番モードの自動切り替え

### Package.jsonスクリプト:

```json
{
  "test:e2e:mocked": "playwright test --project=remix-dev",
  "test:e2e:dev": "./tests/scripts/run-tests.sh -e development",
  "test:e2e:ci": "./tests/scripts/run-tests.sh -e ci"
}
```

## メリット

### 1. **外部依存関係なし**
- 実際のAWS SESアクセスを必要とせずにテスト実行
- テスト中に実際のメールを送信しない
- より高速なテスト実行

### 2. **包括的なカバレッジ**
- すべてのフォーム検証シナリオをテスト
- ハッピーパスとエラー条件をカバー
- エッジケースとセキュリティシナリオを含む

### 3. **信頼性と決定性**
- 制御されたモック動作
- 一貫したテスト結果
- 設定可能な失敗シミュレーション

### 4. **開発者フレンドリー**
- 詳細なログとデバッグ
- 簡単なテストデータ管理
- 日本語での明確なエラーメッセージ

### 5. **CI/CD対応**
- 継続的インテグレーション用に最適化
- 環境固有の設定
- 自動セットアップ/ティアダウン

## モックメール検証

### メール内容の検証:
```typescript
const gymEmail = mockEmails.find(email => 
  email.subject.includes("体験・見学の申し込みがありました")
);
expect(gymEmail?.body).toContain("田中太郎");
expect(gymEmail?.to).toContain("ryosuke.horie37@gmail.com");

const applicantEmail = mockEmails.find(email => 
  email.subject.includes("【ヒデズキック】体験・見学のご予約を承りました")
);
expect(applicantEmail?.body).toContain("田中太郎 様");
```

### 統計追跡:
```typescript
const stats = MockServiceUtils.getMockEmailStats();
expect(stats.total).toBe(6);    // 3予約 × 2メール
expect(stats.sent).toBe(6);
expect(stats.failed).toBe(0);
```

## デバッグとトラブルシューティング

### デバッグ設定:
```typescript
// デバッグログの有効化
process.env.DEBUG_MOCK_SERVICES = "true";
process.env.DEBUG_EMAIL_CONTENT = "true";
process.env.DEBUG_FORM_VALIDATION = "true";
```

### スクリーンショット取得:
```typescript
// 失敗時の自動スクリーンショット
await testUtils.takeDebugScreenshot("reservation-error");
```

### 環境検証:
```typescript
// テスト環境セットアップの検証
const validation = validateTestEnvironment();
if (!validation.isValid) {
  console.error("環境の問題:", validation.errors);
}
```

## 次のステップ

1. **統合**: 予約アクションをテスト対応メールサービスを使用するよう更新
2. **カバレッジ**: 特定のビジネス要件に基づくより多くのテストシナリオの追加
3. **パフォーマンス**: モックサービスでのパフォーマンステストの追加
4. **監視**: テスト結果レポートとメトリクスの追加
5. **ドキュメント**: テスト手順でREADMEを更新

この包括的なテスト環境は、日本語ロケール要件を維持し、テスト中の外部サービス依存関係を避けながら、信頼性の高いE2Eテストのための堅実な基盤を提供します。