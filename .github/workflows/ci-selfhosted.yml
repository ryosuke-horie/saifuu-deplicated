# セルフホストランナー用CI/CDワークフロー
# 軽量ジョブ（型チェック、リント、ユニットテスト、ビルド、Storybook）を並列実行
#
# 設計判断：
# - セルフホストランナーで高速実行、GitHub Actions無料枠を節約
# - E2Eテストは別途GitHub hosted runnerで実行
# - 並列ジョブによる実行時間最適化
# - 適切なファイル変更トリガーで無駄な実行を回避

name: CI Self-Hosted

on:
  pull_request:
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.json'
      - '**/*.md'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.storybook/**'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
      - 'biome.json'
      - 'tsconfig.json'
      - '.github/workflows/ci-selfhosted.yml'
      # check.ymlの削除により重複実行を防止
  push:
    branches: [main]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.json'
      - 'package.json'
      - 'pnpm-lock.yaml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # 型チェックとリント
  check:
    runs-on: [self-hosted, linux]
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm manually
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run type checking and linting
        run: pnpm run check

  # ユニットテスト
  unit-tests:
    runs-on: [self-hosted, linux]
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm manually
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run unit tests
        run: pnpm test:unit
        env:
          CI: true
          NODE_ENV: test
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7

  # アプリケーションビルド
  build:
    runs-on: [self-hosted, linux]
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm manually
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm run build
        env:
          NODE_ENV: production
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build/
          retention-days: 7

  # Storybookビルド（一時的に無効化 - React Router競合対応中）
  # storybook:
  #   runs-on: [self-hosted, linux]
  #   timeout-minutes: 15
  #   
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #       with:
  #         version: '10'
  #         standalone: true
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '22'
  #         cache: 'pnpm'
  #     
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #     
  #     - name: Build Storybook
  #       run: pnpm run build-storybook
  #       env:
  #         NODE_ENV: production
  #     
  #     - name: Upload Storybook artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: storybook-static
  #         path: storybook-static/
  #         retention-days: 7

